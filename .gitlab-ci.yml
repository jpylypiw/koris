image: mleiner/kolt-base:0.2

stages:
  - build
  - cleanup
  - test
  - integration 

build:
  stage: build
  image: python:3.6-stretch
  variables:
    LC_ALL: "C.UTF-8"
    LANG: "C.UTF-8"
  script:
  - "apt-get update -y"
  - "pip3 install pipenv"
  - "pipenv install"

cleanup:
  stage: cleanup
  image: python:3.6-stretch
  variables:
    LC_ALL: "C.UTF-8"
    LANG: "C.UTF-8"
  script:
  - "apt-get update -y"
  - "pip3 install pipenv"
  - "pipenv install"


test:
  script:
    - pip3 install -e .
    - make coverage PY=python3

integration:
  script:
    - sed -i "s/%%date%%/$(date '+%Y-%m-%d')'/g" tests/koris_test.yml
    - kolt k8s tests/koris_test.yml
    - kubectl get nodes --kubeconfig=koris-test-admin.conf
    - kubectl run nginx --image=nginx --kubeconfig=koris-test-admin.conf
    - kubectl expose deploy nginx --type=LoadBalancer
    - curl $(kubectl get --export -o jso ...)
